<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="littlesqx's blog">
    <meta name="keyword"  content="git php mysql laravel littlesqx">
    <link rel="shortcut icon" href="https://littlesqx-github-io.b0.upaiyun.com/img/favicon.ico">

    <title>[译]The 2018 Guide to Building Secure PHP Software - Littlesqx Blog</title>

    <link rel="canonical" href="https://littlesqx.github.io/2017/12/24/the-2018-guide-to-building-secure-php-software/">

    <!-- nprogress CSS -->
    <link href="https://littlesqx-github-io.b0.upaiyun.com/css/nprogress.min.css" rel="stylesheet">
    <style media="screen">
      #nprogress .bar {
        height: 3px;
      }
    </style>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://littlesqx-github-io.b0.upaiyun.com/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="https://littlesqx-github-io.b0.upaiyun.com/css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="https://littlesqx-github-io.b0.upaiyun.com/css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    
    <link rel="stylesheet" href="https://littlesqx-github-io.b0.upaiyun.com/css/gitment.min.css">
    
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Littlesqx Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/bg.png" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('https://littlesqx-github-io.b0.upaiyun.com/img/bg.png')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#PHP" title="PHP">PHP</a>
                        
                        <a class="tag" href="/tags/#翻译" title="翻译">翻译</a>
                        
                    </div>
                    <h1>[译]The 2018 Guide to Building Secure PHP Software</h1>
                    
                    
                    <h2 class="subheading"></h2>
                    
                    <span class="meta">Posted by Littlesqx on December 24, 2017</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

				<blockquote>
  <p>2018PHP应用程序安全设计指北！</p>
</blockquote>

<h3 id="目录">目录</h3>
<ul>
  <li><a href="#前言">前言</a></li>
  <li><a href="#php-版本">PHP 版本 / PHP Versions</a></li>
  <li><a href="#依赖管理">Composer依赖管理 / Dependency Management with Composer</a>
    <ul>
      <li><a href="#推荐扩展">推荐扩展 / Recommended Packages</a></li>
    </ul>
  </li>
  <li><a href="#https和浏览器安全">HTTPS和浏览器安全 / HTTPS and Browser Security</a>
    <ul>
      <li><a href="#安全请求头">安全请求头 / Security Headers</a></li>
      <li><a href="#子资源完整性">子资源完整性 / Subresource Integrity</a></li>
      <li><a href="#文档关系">文档关系 / Document Relationships</a></li>
    </ul>
  </li>
  <li><a href="#开发安全的php程序">开发安全的PHP程序 / Developing Secure PHP Software</a>
    <ul>
      <li><a href="#数据库注入">数据库注入 / Database Interaction</a></li>
      <li><a href="#文件上传">文件上传 / File Uploads</a></li>
      <li><a href="#跨站脚本">跨站脚本 / Cross-Site Scripting (XSS)</a></li>
      <li><a href="#跨站请求伪造">跨站请求伪造 / Cross-Site Request Forgery (CSRF)</a></li>
      <li><a href="#xml-攻击-xxe-xpath-injection">XML 攻击 / XML attacks (XXE, XPath Injection)</a></li>
      <li><a href="#反序列化和php对象注入">反序列化和PHP对象注入 / Deserialization and PHP Object Injection</a></li>
      <li><a href="#密码散列">密码散列 / Password Hashing</a></li>
      <li><a href="#通用加密">通用加密 / General-Purpose Cryptography</a></li>
      <li><a href="#随机性">随机性 / Randomness</a></li>
      <li><a href="#服务器端https请求">服务器端HTTPS请求 / Server-Side HTTPS Requests</a></li>
      <li><a href="#避免的事情">避免的事情 / Things to Avoid</a></li>
    </ul>
  </li>
  <li><a href="#专业用法">专业用法 / Specialized Use-Cases</a>
    <ul>
      <li><a href="#可搜索的加密">可搜索的加密 / Searchable Encryption</a></li>
      <li><a href="#没有side-channels的基于令牌的身份验证">没有Side-Channels的基于令牌的身份验证 / Token-based Authentication without Side-Channels</a></li>
      <li><a href="#开发安全的api">开发安全的API / Developing Secure APIs</a></li>
      <li><a href="#使用chronicle记录安全事件">使用Chronicle记录安全事件 / Security Event Logging with Chronicle</a></li>
    </ul>
  </li>
  <li><a href="#作者的一些话">作者的一些话 / A Word From the Author</a></li>
  <li><a href="#资源">资源 / Resources</a></li>
</ul>

<h3 id="前言">前言</h3>

<p>2018年将至，一般程序员（特别是Web开发程序员）应当抛弃过去开发PHP程序的很多不好的习惯和观念了。虽然部分人不以为意，但是这确实是事实。</p>

<p>这个指南应该以重点部分作为<a href="http://www.phptherightway.com/">PHP: The Right Way</a>安全章节的补充，而不是以一般的PHP编程话题。</p>

<h3 id="正文">正文</h3>

<h4 id="php-版本">PHP 版本</h4>

<blockquote>
  <p>除非逼不得已，否则请在2018年使用PHP 7.2, 并且计划2019年初切换到PHP 7.3。</p>
</blockquote>

<p>PHP 7.2 已于2017年11月30日发布。</p>

<p>写这篇文章的时候，只有7.1和7.2版本还在被PHP官方积极维护，而5.6和7.0只在大概1年内提供安全补丁更新。</p>

<p>对于其他官方不维护的PHP版本，虽然某些操作系统会提供长期支持和维护，但这其实通常是有害的。尤其是他们提供安全支持补丁却没有版本号，这使得很难解释系统的安全性（仅仅知道PHP版本）。</p>

<p>因此，无论其他供应商提出了什么承诺，如果可以，你就应该在任何时候都坚决地使用<a href="http://php.net/supported-versions.php">官方提供支持的PHP版本</a>。这样，尽管最终是一个短暂的安全版本，但一个不断致力于的升级版本，总会让你收获一些意外的惊喜。</p>

<h4 id="依赖管理">依赖管理</h4>

<blockquote>
  <p>人生苦短，我用Composer</p>
</blockquote>

<p>在PHP生态中，<a href="https://getcomposer.org/">Composer</a>是最先进的依赖管理方案。我们推荐PHP之道中关于<a href="http://www.phptherightway.com/#dependency_management">依赖管理</a>的完整章节。</p>

<p>如果你没有使用Composer来管理应用的依赖，最终（hopefully later but most likely sooner）会导致应用里某个依赖会严重过时，然后老旧版本中的漏洞会被利用于计算机犯罪。</p>

<p><strong>重要</strong>： 开发软件时，时常记得<a href="http://www.phptherightway.com/#updating-your-dependencies">保持依赖的更新</a>。幸运地，这只需一行命令：</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>composer update
</code></pre>
</div>
<p>如果你正在使用某些专业的，需要使用PHP扩展（C语言编写），那你不能使用Composer管理，而需要PECL。</p>

<h5 id="推荐扩展">推荐扩展</h5>

<p>不管你正在编写什么，你总会受益于这些依赖。这是除了大多数PHP程序员的推荐（PHPUnit, PHP-CS-Fixer, …）外的补充。</p>

<p><strong>roave/security-advisories</strong></p>

<p><a href="https://github.com/Roave/SecurityAdvisories">Roave’s security-advisories</a>使用<a href="https://github.com/FriendsOfPHP/security-advisories">Friends of PHP repository</a>确保你的项目没有依赖一些已知易受攻击的依赖。</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>composer require roave/security-advisories:dev-master    
</code></pre>
</div>

<p>或者，你可以<a href="https://github.com/FriendsOfPHP/security-advisories#checking-for-vulnerabilities">上传你的<code class="highlighter-rouge">composer.lock</code>文件到Sensio Labs</a>，作为例行自动化漏洞评估工作流的一部分，以提醒发现任何过时的软件包。</p>

<p><strong>vimeo/psalm</strong></p>

<p><a href="https://github.com/vimeo/psalm">Psalm</a>是一个帮助你识别代码里可能存在bugs的静态分析工具。还有其他很好的静态分析工具（例如<a href="https://github.com/phan/phan">Phan</a>和<a href="https://github.com/phpstan/phpstan">PHPStan</a>都很棒），但当你发现你需要支持PHP 5，Psalms将是PHP 5.4+的首选。</p>

<p>使用Psalm挺简单：</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c"># Version 1 doesn't exist yet, but it will one day:</span>
composer require --dev vimeo/psalm:^0

<span class="c"># Only do this once:</span>
vendor/bin/psalm --init

<span class="c"># Do this as often as you need:</span>
vendor/bin/psalm
</code></pre>
</div>

<p>如果你是第一次在现有代码库运行，可能会看到很多红色错误。但除非你在构建像WordPress那么大的程序，否则努力通过所有测试绝不是艰巨的。</p>

<p>无论使用哪种静态分析工具，我们都推荐你能将他加入到<a href="https://zh.wikipedia.org/wiki/%E6%8C%81%E7%BA%8C%E6%95%B4%E5%90%88">持续集成工作流</a>（Continuous Integration workflow）中，以便在每次更改代码中运行。</p>

<h4 id="https和浏览器安全">HTTPS和浏览器安全</h4>

<blockquote>
  <p>HTTPS, <a href="https://www.ssllabs.com/">which should be tested</a>, and <a href="https://securityheaders.io/">security headers</a> .</p>
</blockquote>

<p>2018年，不安全的HTTP网站将不再被接受。幸运的是，由于ACME 协议 和 <a href="https://letsencrypt.org/">Let’s Encrypt certificate authority</a>，免费的TLS证书成为了可能。</p>

<p>将 ACME 集成到你的服务器，小菜一碟。</p>

<ul>
  <li><a href="https://caddyserver.com/">Caddy</a>: 自动加入。</li>
  <li><a href="https://letsencrypt.org/2017/10/17/acme-support-in-apache-httpd.html">Apache</a>: 很快作为<code class="highlighter-rouge">mod_md</code>可用。在此之前，<a href="https://www.digitalocean.com/community/tutorials/how-to-secure-apache-with-let-s-encrypt-on-ubuntu-16-04">网上很多高质量教程</a>。</li>
  <li><a href="https://www.nginx.com/blog/using-free-ssltls-certificates-from-lets-encrypt-with-nginx/">Nginx</a>: 相对简单。</li>
</ul>

<p>你也许会想，“好，我已经有TLS证书了，为了网站变得安全和快速，得花些时间折腾配置信息。”</p>

<p><strong>不！</strong><a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">Mozilla做了好事情！</a>。你可以根据网站的目标受众，使用配置生成器生成<a href="https://wiki.mozilla.org/Security/Server_Side_TLS">推荐套件</a>。</p>

<p>如果你希望网站安全，HTTPS(HTTP over TLS)是<a href="https://stackoverflow.com/a/2336738/2224584">绝对不能妥协</a>的。使用HTTPS立刻就能消除多种攻击（中间人攻击、窃听、重放攻击以及若干允许用户模仿的会话形式的攻击）。</p>

<h5 id="安全请求头">安全请求头</h5>

<p>在服务器使用HTTPS确实为用户提供了许多安全性和性能方面的好处，但也还能通过利用某些浏览器的安全功能来进一步提升安全性。而这大部分会涉及到与返回内容一起返回的请求头。</p>

<ul>
  <li><code class="highlighter-rouge">Content-Security-Policy</code>
    <ul>
      <li>你需要该请求头，因为它提供了对于浏览器是否允许加载内部和外部资源的细化控制，从而为跨域脚本攻击漏洞提供了有效防御层。</li>
      <li>参阅<a href="https://github.com/paragonie/csp-builder">CSP-Builder</a>，以便快速简便地部署/管理内容安全策略（Content Security Policies）。</li>
      <li>为了更加深入的分析， Scott Helme’s <a href="https://scotthelme.co.uk/content-security-policy-an-introduction/">introduction to Content-Security-Policy headers</a>，会是一个很好的引导。</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">Expect-CT</code>
    <ul>
      <li>你需要该请求头，因为它能通过强制某些不良行为者将其错误证书的证据颁发到可公开验证的仅可追加的数据结构，从而针对流氓/受损的证书颁发机构增加一层防护。</li>
      <li>优先设置为<code class="highlighter-rouge">enforce,max-age=30</code>。只要你有足够的自信该请求头不会造成服务中断，增加<code class="highlighter-rouge">max-age</code>吧。</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">Referrer-Policy</code>
    <ul>
      <li>你需要该请求头，因为它允许你控制用户的行为信息是否泄露给第三方。</li>
      <li>同样地，Scott Helme提供了<a href="https://scotthelme.co.uk/a-new-security-header-referrer-policy/">一篇关于Referrer-Policy请求头介绍好文</a>。</li>
      <li>除非有理由允许更加宽松的设置，否则请设置为<code class="highlighter-rouge">same-origin</code>或<code class="highlighter-rouge">no-referrer</code>。</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">Strict-Transport-Security</code>
    <ul>
      <li>你需要该请求头，因为它告诉浏览器通过HTTPS而不是不安全的HTTP，将future requests设为同源。</li>
      <li>在第一次部署时，将其设置为<code class="highlighter-rouge">max-age = 30</code>，然后当你确信没有任何内容会中断时，将此值增加到某个较大的值（例如31536000）。</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">X-Content-Type-Options</code>
    <ul>
      <li>你需要该请求头，因为MIME类型的混淆可能会导致不可预知的结果，包括奇怪的允许XSS漏洞的边缘情况。这最好伴随着一个标准的Content-Type请求头。</li>
      <li>除非需要默认的行为（例如文件的下载），否则请设置为<code class="highlighter-rouge">nosniff</code>。</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">X-Frame-Options</code>
    <ul>
      <li>你需要该请求头，因为它允许你防止点击劫持。</li>
      <li>设置为<code class="highlighter-rouge">DENY</code> (或者<code class="highlighter-rouge">SAMEORIGIN</code>, 但仅仅当你使用 <frame> 元素的时候)。</frame></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">X-XSS-Protection</code>
    <ul>
      <li>你需要该请求头，因为它启用了一些默认情况下未启用的浏览器反XSS功能。</li>
      <li>设置为<code class="highlighter-rouge">1; mode=block</code>。</li>
    </ul>
  </li>
</ul>

<p>同样，如果你使用PHP的内置会话管理功能（建议使用），则可能需要调用<code class="highlighter-rouge">session_start()</code></p>
<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nb">session_start</span><span class="p">([</span>
    <span class="s1">'cookie_httponly'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s1">'cookie_secure'</span> <span class="o">=&gt;</span> <span class="kc">true</span>
<span class="p">]);</span>
</code></pre>
</div>
<p>这会强制你的应用在发送会话标识符时使用HTTP-Only和Secure标志，从而防止XSS攻击窃取用户的Cookie，并强制它们分别通过HTTPS发送。 我们之前在2015年的博客文章中介绍了<a href="https://paragonie.com/blog/2015/04/fast-track-safe-and-secure-php-sessions">安全的PHP会话</a>。</p>

<h5 id="子资源完整性">子资源完整性</h5>

<p>在将来的某个时候，你也许会使用CDN来加载网站的公共JavaScript/CSS库。安全工程师已经遇见了这存在一个明显的风险，如果很多网站使用CDN提供内容，Hack和替换CDN（获得了CDN的控制权），则可以注入（恶意）代码到成千上万的网站。</p>

<p>查阅<a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/%E5%AD%90%E8%B5%84%E6%BA%90%E5%AE%8C%E6%95%B4%E6%80%A7">子资源完整性</a>吧。</p>

<p>子资源完整性（SRI，Subresource integrity）允许你将希望CDN服务的文件的内容进行哈希处理。目前实行的SRI只允许使用安全的密码散列函数，这意味着攻击者不可能生成与原始文件哈希相同的恶意版本资源。</p>

<p>一个真实例子: <a href="https://v4-alpha.getbootstrap.com/">Bootstrap v4-alpha uses SRI in their CDN example snippet</a></p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;link</span>
    <span class="na">rel=</span><span class="s">"stylesheet"</span>
    <span class="na">href=</span><span class="s">"https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"</span>
    <span class="na">integrity=</span><span class="s">"sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ"</span>
    <span class="na">crossorigin=</span><span class="s">"anonymous"</span>
<span class="nt">/&gt;</span>
<span class="nt">&lt;script
    </span><span class="na">src=</span><span class="s">"https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"</span>
    <span class="na">integrity=</span><span class="s">"sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn"</span>
    <span class="na">crossorigin=</span><span class="s">"anonymous"</span>
<span class="nt">&gt;&lt;/script&gt;</span>
</code></pre>
</div>

<h5 id="文档关系">文档关系</h5>

<p>Web开发人员经常在超链接上设置目标属性（例如，<code class="highlighter-rouge">target ="_ blank"</code>在新窗口中打开链接）。但是，如果你没有传递<code class="highlighter-rouge">rel ="noopener"</code>标签，则可以<a href="https://mathiasbynens.github.io/rel-noopener/">允许目标页面控制当前页面</a>。</p>

<p>不要这样做：</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://example.com"</span> <span class="na">target=</span><span class="s">"_blank"</span><span class="nt">&gt;</span>Click here<span class="nt">&lt;/a&gt;</span>
</code></pre>
</div>

<p>这会让<code class="highlighter-rouge">http://example.com</code>页面能控制当前页面。</p>

<p>而应该这样做：</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://example.com"</span> <span class="na">target=</span><span class="s">"_blank"</span> <span class="na">rel=</span><span class="s">"noopener noreferrer"</span><span class="nt">&gt;</span>Click here<span class="nt">&lt;/a&gt;</span>
</code></pre>
</div>

<p>通过这样在新窗口打开<code class="highlighter-rouge">https://example.com</code>，当前窗口的控制权也不会授予可能的恶意第三方。</p>

<p>可以更加<a href="https://www.jitbit.com/alexblog/256-targetblank---the-most-underestimated-vulnerability-ever">深入研究</a>。</p>

<h4 id="开发安全的php程序">开发安全的PHP程序</h4>

<p>如果应用程序安全性对你来说是一个新话题，请从<a href="https://paragonie.com/blog/2015/08/gentle-introduction-application-security">应用程序安全性简介</a>开始吧。</p>

<p>大多数安全专家指出，开发者可以使用<a href="https://www.owasp.org/index.php/Top_10_2017-Top_10">OWASP Top 10</a>等资源开始着手。</p>

<p>但是，大多数常见的漏洞也可以是相同高等级的安全问题（例如代码和数据没有完全分离、逻辑不严谨和健全、操作环境不安全或是可破译的密码协议等）。</p>

<p>我们的假设是，应该授予安全新手知道一些更简单、基础的安全知识和问题，并如何解决这些问题，应该是一个更好的、长远的安全工程。</p>

<p>因此，<a href="https://paragonie.com/blog/2017/04/checklist-driven-security-considered-harmful">我们避免推荐十大或二十大安全清单</a>。</p>

<h5 id="数据库注入">数据库注入</h5>

<blockquote>
  <p><a href="https://paragonie.com/blog/2015/05/preventing-sql-injection-in-php-applications-easy-and-definitive-guide">避免PHP程序存在SQL注入。</a></p>
</blockquote>

<p>如果你是自己编写SQL代码，请确保使用<code class="highlighter-rouge">prepared语句</code>，并且从网络或文件系统提供的信息都作为参数传递，而不是字符串拼接的形式。此外，确保你<a href="https://stackoverflow.com/a/12202218">没有使用模拟的prepared语句</a>。</p>

<p>为了达到好的效果，可以使用<a href="https://github.com/paragonie/easydb">EasyDB</a>。</p>

<p>不要这样做：</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="cm">/* Insecure code: */</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$pdo</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s2">"SELECT * FROM users WHERE username = '"</span> <span class="o">.</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]</span> <span class="o">.</span> <span class="s2">"'"</span><span class="p">);</span>
</code></pre>
</div>

<p>应该这样做：</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="cm">/* Secure against SQL injection: */</span>
<span class="nv">$results</span> <span class="o">=</span> <span class="nv">$easydb</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="s2">"SELECT * FROM users WHERE username = ?"</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]);</span>
</code></pre>
</div>

<p>还有其他数据库抽象层提供了相同的安全性（EasyDB实际上是在使用PDO，但在实际的<code class="highlighter-rouge">prepare</code>语句前避免了<code class="highlighter-rouge">prepared</code>语句模拟）。 只要用户输入不会影响查询的结构，就很安全（包括存储过程）。</p>

<h5 id="文件上传">文件上传</h5>

<blockquote>
  <p>深入：<a href="https://paragonie.com/blog/2015/10/how-securely-allow-users-upload-files">如何安全地允许用户上传文件？</a></p>
</blockquote>

<p>接受文件上传是一个冒险的提议，但只要采取一些基本的预防措施，是能保证安全的。也就是说，允许文件直接上传的话，这些文件可能会被意外的允许执行或解释。上传的文件应该是只读(read-only)或读写(read-write)的，永远不应该可执行(executable)。</p>

<p>如果你的网站根目录是<code class="highlighter-rouge">/var/www/example.com</code>，请不要保存上传文件在<code class="highlighter-rouge">/var/www/example.com/uploaded_files</code>。</p>

<p>而应该保存到一个不能直接访问的目录（例如：<code class="highlighter-rouge">/var/www/example.com-uploaded/</code>），以免意外地将其作为服务器端脚本执行，并获得执行远程代码的后门。</p>

<p>一个更加简洁的方法是将网站根目录往下移动一个层级（即：<code class="highlighter-rouge">/var/www/example.com/public</code>）。</p>

<p>如何安全地下载这些上传文件也是一个问题。</p>

<ul>
  <li>直接访问SVG图像类型时，将在用户浏览器执行JavaScript代码。尽管<a href="https://github.com/w3c/svgwg/issues/266">它的MIME类型中的<code class="highlighter-rouge">image/</code>前缀具有误导性</a>，但是这是正确的。</li>
  <li>正如前面提及的，MIME类型嗅探可能导致类型混淆攻击。请参阅<a href="#安全请求头">X-Content-Type-Options</a>。</li>
  <li>如果你放弃前面关于如何安全地存储上传文件的建议，攻击者就会通过上传.php或.phtml文件，直接在浏览器中访问文件来执行任意代码，从而完全控制服务器。</li>
</ul>

<h5 id="跨站脚本">跨站脚本</h5>

<blockquote>
  <p><a href="https://paragonie.com/blog/2015/06/preventing-xss-vulnerabilities-in-php-everything-you-need-know">关于PHP中的跨站脚本攻击，你想知道的都在这里</a></p>
</blockquote>

<p>同样地，预防XSS和SQL注入是一样简单的。我们有简单而易用的API来分离文档结构（structure of a document）和填充的数据。</p>

<p>然而，实际上还有很多Web开发程序员仍是通过生成一大串HTML代码作为响应的形式开发。并且，这不是PHP独有的现实，这是所有Web开发程序员都应该重视的。</p>

<p>减少XSS漏洞不失为一个好方法。总之，前面谈及的<a href="#浏览器安全">浏览器安全的章节</a>就显得十分相关了。简言之：</p>

<ul>
  <li>尽量避免输出和输入（<code class="highlighter-rouge">Always escape on output, never on input</code>）。如果你把已清洗的数据（sanitized data）保存在数据库，然后在其它地方被发现了SQL注入漏洞，攻击者将通过恶意程序污染这些受信任的已清洗数据（trusted-to-be-sanitized record），从而绕开XSS保护。</li>
  <li>如果你的框架有一个提供自动上下文过滤的模板引擎，那就使用它吧。这些工作可由框架安全地做到。</li>
  <li><code class="highlighter-rouge">echo htmlentities（$ string，ENT_QUOTES | ENT_HTML5，'UTF-8'）</code> 是一种安全、有效的方法阻止UTF-8编码的网页上的所有XSS攻击，但不是任何HTML都有效。</li>
  <li>如果你的环境要求你使用Markdown而不是HTML，那就不要使用HTML了。</li>
  <li>如果你需要使用原生HTML（没有使用模板引擎），参阅第一点，并且使用<a href="http://htmlpurifier.org/">HTML Purifier</a>吧。HTML Purifier不适合转义为HTML属性上下文（HTML attribute context）。</li>
</ul>

<h5 id="跨站请求伪造">跨站请求伪造</h5>

<p>跨站请求伪造（CSRF）是一种混淆的代理攻击，通过诱导用户的浏览器代表攻击者执行恶意的HTTP请求（使用的是该用户的权限）。</p>

<p>这在一般情况下是很容易解决的，只需两步：</p>

<ul>
  <li>使用HTTPS。这是先决条件。没有HTTPS的话，任何保护措施都是脆弱的，虽然HTTPS本身并不防御CSRF。</li>
  <li>增加基本的Challenge-response authentication。
    <ul>
      <li>为每个表单添加一个隐藏的表单属性。</li>
      <li>填充一个密码安全的随机值（称为令牌）。</li>
      <li>验证是否提供了隐藏的表单属性，以及是否匹配上期望值。</li>
    </ul>
  </li>
</ul>

<p>我们写了一个名为<a href="https://github.com/paragonie/anti-csrf">Anti-CSRF</a>的库，并且：</p>

<ul>
  <li>你可以使每个令牌只能使用一次，以防止重放攻击。
    <ul>
      <li>多个令牌存储在后端。</li>
      <li>一旦令牌获取完，令牌会循环使用。</li>
    </ul>
  </li>
  <li>每个令牌可以绑定特定的URL。
    <ul>
      <li>如果某个令牌泄露了，它不能在不同的上下文使用。</li>
    </ul>
  </li>
  <li>令牌可以绑定特定的IP地址。</li>
  <li>v2.1后，令牌可以重复使用（例如供Ajax使用）。</li>
</ul>

<p>如果你没有使用防止CSRF漏洞的框架，请将Anti-CSRF放在一边。在不久的将来，<a href="https://www.sjoerdlangkemper.nl/2016/04/14/preventing-csrf-with-samesite-cookie-attribute/">SameSite cookies将允许我们更简单地避免CSRF攻击</a>。</p>

<h5 id="xml-攻击-xxe-xpath-injection">XML 攻击 (XXE, XPath Injection)</h5>

<p>在处理大量XML的应用程序中存在两个主要的漏洞：</p>

<ul>
  <li>XML External Entities (XXE)</li>
  <li>XPath注入</li>
</ul>

<p><a href="https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing">除此之外</a>，XXE攻击可用作包含攻击代码的本地/远程文件的启动器。</p>

<p>早期版本的Google Docs被着名于XXE，但除了在很大程度上使用XML的商业应用程序之外，基本闻所未闻。</p>

<p>针对XXE袭击的主要缓解措施:</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nb">libxml_disable_entity_loader</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</code></pre>
</div>

<p>除XML文档外，<a href="https://www.owasp.org/index.php/XPATH_Injection">XPath注入</a>与SQL注入非常相似。</p>

<p>幸运的是，将用户输入传递给XPath查询的情况在PHP生态中非常罕见。</p>

<p>而不幸的是，这也意味着PHP生态中不存在可用的最佳避免措施（预编译和参数化XPath查询）。最好的办法是在任何涉及XPath查询的数据上设置允许使用的字符白名单。</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">declare</span><span class="p">(</span><span class="nx">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

<span class="k">class</span> <span class="nc">SafeXPathEscaper</span>
<span class="p">{</span>
    <span class="sd">/**
     * @param string $input
     * @return string
     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">allowAlphaNumeric</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$input</span><span class="p">)</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">\preg_replace</span><span class="p">(</span><span class="s1">'#[^A-Za-z0-9]#'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$input</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="sd">/**
     * @param string $input
     * @return string
     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">allowNumeric</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$input</span><span class="p">)</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">\preg_replace</span><span class="p">(</span><span class="s1">'#[^0-9]#'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$input</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Usage:
</span><span class="nv">$selected</span> <span class="o">=</span> <span class="nv">$xml</span><span class="o">-&gt;</span><span class="na">xpath</span><span class="p">(</span>
    <span class="s2">"/user/username/"</span> <span class="o">.</span> <span class="nx">SafeXPathEscaper</span><span class="o">::</span><span class="na">allowAlphaNumeric</span><span class="p">(</span>
        <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">);</span>
</code></pre>
</div>

<p>白名单总会比黑名单更安全。</p>

<h5 id="反序列化和php对象注入">反序列化和PHP对象注入</h5>

<blockquote>
  <p>深入探究： <a href="https://paragonie.com/blog/2016/04/securely-implementing-de-serialization-in-php">在PHP中安全地实现（反）序列化</a></p>
</blockquote>

<p>如果你将不可信的数据传递给<code class="highlighter-rouge">unserialize()</code>，则通常是这两个结果之一：</p>

<ul>
  <li>PHP对象注入，它能用于启动POP链（POP chain）并触发其他误用对象的漏洞。</li>
  <li>PHP解释器本身的内存损坏。</li>
</ul>

<p>大多数开发人员更喜欢使用JSON序列化，这是对其软件安全状况的显著改进。但请记住，<a href="http://lukasmartinelli.ch/web/2014/11/17/php-dos-attack-revisited.html"><code class="highlighter-rouge">json_decode()</code>容易受到散列冲突拒绝服务（Hash-DoS）攻击</a>。不幸的是，<a href="https://bugs.php.net/bug.php?id=70644">PHP的Hash-DOS问题还没有得到彻底解决</a>。</p>

<p>从<code class="highlighter-rouge">djb33</code>迁移到<code class="highlighter-rouge">Siphash</code>，对于字符串输入，哈希输出的最高位设置为1，对于整数输入设置为0，使用<code class="highlighter-rouge">CSPRNG</code>提供的请求密钥将完全解决这些攻击。</p>

<p>不幸的是，PHP团队还没有准备好放弃他们已经在PHP 7系列中取得的性能提升，所以很难说服他们放弃djb33（这是非常快但不安全的） 赞成SipHash（这也是快速的，但不像djb33那么快，但更安全）。 
如果性能受到重大影响，可能会阻碍未来版本的采用，但也影响了安全性。</p>

<p>因此，最好的办法是：</p>

<ul>
  <li>使用<code class="highlighter-rouge">JSON</code>，因为它比<code class="highlighter-rouge">unserialize()</code>更安全。</li>
  <li>在任何可能的地方，确保输入在反序列化之前被认证。
    <ul>
      <li>对于提供给用户的数据，通过一个只有服务器知道的秘钥使用<code class="highlighter-rouge">sodium_crypto_auth()</code>和<code class="highlighter-rouge">sodium_crypto_auth_verify()</code>验证。</li>
      <li>对于第三方提供的数据，让他们使用<code class="highlighter-rouge">sodium_crypto_sign()</code>签名他们的JSON消息，然后使用<code class="highlighter-rouge">sodium_crypto_sign_open()</code>和第三方公钥验证消息。
        <ul>
          <li>如果你需要对传输的签名进行十六进制或Base64位编码，也可以使用分离的签名API。</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>如果你无法验证JSON字符串，请严格限制速度并阻止IP地址，以减轻重复的违规者。</li>
</ul>

<h5 id="密码散列">密码散列</h5>

<blockquote>
  <p>深入探究：<a href="https://paragonie.com/blog/2016/02/how-safely-store-password-in-2016">2016年，如何安全地保存用户密码</a></p>
</blockquote>

<p>安全的密码存储曾经是一个激烈争论的话题，但现在实现起来相当微不足道，特别是在PHP中：</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$hash</span> <span class="o">=</span> <span class="nx">\password_hash</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nx">PASSWORD_DEFAULT</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">\password_verify</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nv">$hash</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// Authenticated.
</span>    <span class="k">if</span> <span class="p">(</span><span class="nx">\password_needs_rehash</span><span class="p">(</span><span class="nv">$hash</span><span class="p">,</span> <span class="nx">PASSWORD_DEFAULT</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// Rehash, update database.
</span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>你甚至不需要知道在后台使用什么算法，因为如果你使用最新版本的PHP，你也将使用当前最新的技术，用户的密码将会自动进行升级（只要有新的默认算法可用）。</p>

<p>无论你做什么，都<a href="https://paragonie.com/blog/2016/08/on-insecurity-popular-open-source-php-cms-platforms#wordpress-password-storage">不要做WordPress所做的事情</a>。</p>

<p>你可能会好奇，从PHP 5.5到7.2，默认算法是Bcrypt。在未来，它可能会切换到获得<a href="https://password-hashing.net/">密码哈希大赛冠军</a>的Argon2。</p>

<p>如果你以前没有使用<code class="highlighter-rouge">password_*</code> API，那需要迁移遗留哈希，请确保<a href="https://paragonie.com/blog/2016/02/how-safely-store-password-in-2016#legacy-hashes">以这种方式进行</a>。
很多公司搞错了， 最有名的是<a href="https://www.theregister.co.uk/2016/12/15/yahoos_password_hash/">雅虎</a>。 最近，错误地实施传统哈希升级似乎导致了<a href="https://objective-see.com/blog/blog_0x24.html">苹果的iamroot错误</a>。</p>

<h5 id="通用加密">通用加密</h5>

<p>这是一些我们详细写了的话题：</p>

<ul>
  <li><a href="https://paragonie.com/blog/2015/05/using-encryption-and-authentication-correctly">Using Encryption and Authentication Correctly</a> (2015)</li>
  <li>Recommended: <a href="https://paragonie.com/blog/2015/11/choosing-right-cryptography-library-for-your-php-project-guide">Choosing the Right Cryptography Library for your PHP Project: A Guide</a> (2015)</li>
  <li>Recommended: <a href="https://paragonie.com/blog/2015/08/you-wouldnt-base64-a-password-cryptography-decoded">You Wouldn’t Base64 a Password - Cryptography Decoded</a> (2015)</li>
  <li><a href="https://paragonie.com/blog/2017/02/cryptographically-secure-php-development">Cryptographically Secure PHP Development</a> (2017)</li>
  <li>Recommended: <a href="https://paragonie.com/blog/2017/06/libsodium-quick-reference-quick-comparison-similar-functions-and-which-one-use">Libsodium Quick Reference: Similarly-Named Functions and Their Use-Cases</a> (2017)</li>
</ul>

<p>一般来说，你总是希望使用Sodium cryptography library（libsodium）进行应用层加密
如果你需要支持早于7.2的PHP版本（像5.2.4），你可以使用<a href="https://github.com/paragonie/sodium_compat">sodium_compat</a>，基本上可以假设你的用户也是7.2。</p>

<p>在特定情况下，由于严格的算法选择和互操作性，你可能需要不同的库。
如有疑问，请咨询密码专家和密码工程师，了解密码选择是否安全（<a href="https://paragonie.com/services">这是我们提供的服务之一</a>）。</p>

<h5 id="随机性">随机性</h5>

<blockquote>
  <p>深入探究：<a href="https://paragonie.com/blog/2015/07/how-safely-generate-random-strings-and-integers-in-php">如何在PHP中生成安全的整数和字符串？</a></p>
</blockquote>

<p>如果你需要随机数字，请使用<code class="highlighter-rouge">random_int()</code>。
如果你需要随机字节字符串，请使用<code class="highlighter-rouge">random_bytes()</code>。不要使用<code class="highlighter-rouge">mt_rand()</code>，<code class="highlighter-rouge">rand()</code>或<code class="highlighter-rouge">uniqid()</code>。</p>

<p>如果你需要从秘密种子生成伪随机数，而不是<code class="highlighter-rouge">srand()</code>或<code class="highlighter-rouge">mt_srand()</code>，请查阅<a href="https://github.com/paragonie/seedspring">SeedSpring</a>。</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">ParagonIE\SeedSpring\SeedSpring</span><span class="p">;</span>

<span class="nv">$seed</span> <span class="o">=</span> <span class="nx">random_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
<span class="nv">$rng</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SeedSpring</span><span class="p">(</span><span class="nv">$seed</span><span class="p">);</span>

<span class="nv">$data</span> <span class="o">=</span> <span class="nv">$rng</span><span class="o">-&gt;</span><span class="na">getBytes</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
<span class="nv">$int</span> <span class="o">=</span> <span class="nv">$rng</span><span class="o">-&gt;</span><span class="na">getInt</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
</code></pre>
</div>

<h5 id="服务器端https请求">服务器端HTTPS请求</h5>

<blockquote>
  <p>确保TLS证书验证没有被禁用</p>
</blockquote>

<p>随意使用你已经熟悉的任何兼容PSR-7的HTTP客户端。 
我们喜欢Guzzle，有些人喜欢直接使用cURL。</p>

<p>无论你最终使用什么，请确保使用的确定性，以<a href="https://paragonie.com/blog/2017/10/certainty-automated-cacert-pem-management-for-php-software">确保始终可以拥有最新的CACert软件包</a>，
从而允许启用最严格的TLS证书验证设置并保护服务器的出站HTTPS请求。</p>

<p>安装Certainty很简单：</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>composer require paragonie/certainty:^1
</code></pre>
</div>

<p>使用Certainty也很简单：</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?php</span>
    <span class="k">use</span> <span class="nx">ParagonIE\Certainty\RemoteFetch</span><span class="p">;</span>

    <span class="nv">$latestCACertBundle</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nx">RemoteFetch</span><span class="p">())</span><span class="o">-&gt;</span><span class="na">getLatestBundle</span><span class="p">();</span>

    <span class="c1"># cURL users:
</span>    <span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_SSL_VERIFYHOST</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_SSL_VERIFYPEER</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_CAINFO</span><span class="p">,</span> <span class="nv">$latestCACertBundle</span><span class="o">-&gt;</span><span class="na">getFilePath</span><span class="p">());</span>

    <span class="c1"># Guzzle users:
</span>    <span class="sd">/** @var \GuzzleHttp\Client $http */</span>
    <span class="nv">$repsonse</span> <span class="o">=</span> <span class="nv">$http</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span>
        <span class="s1">'https://example.com'</span><span class="p">,</span> 
        <span class="p">[</span>
            <span class="s1">'verify'</span> <span class="o">=&gt;</span> <span class="nv">$latestCACertBundle</span><span class="o">-&gt;</span><span class="na">getFilePath</span><span class="p">()</span>
        <span class="p">]</span>
    <span class="p">);</span>
</code></pre>
</div>

<p>这样可以保护你免受网络服务器与集成的任何第三方API之间的中间人攻击。</p>

<p><strong>我们真的需要Certainty吗？</strong></p>

<p>保护你的系统，Certainty并不是严格的要求。缺少它并不是什么漏洞。
但如果没有Certainty，开源软件必须猜测操作系统的CACert软件包的存在位置，如果猜测错误，它往往会失败并导致可用性问题。
从历史上看，这激励了许多开发人员只是禁用证书验证，以便他们的代码“正常工作”，却没有意识到他们只是将应用程序变成主动攻击。
Certainty通过将CACert捆绑在最新的可预测位置来消除这种激励。Certainty还为希望<a href="https://github.com/paragonie/certainty/blob/master/docs/features/LocalCACertBuilder.md">运行自己的内部CA</a>为企业提供大量的工具。</p>

<p><strong>谁禁用证书验证？</strong></p>

<p>为流行的内容管理系统（WordPress，Magento等）的插件/扩展开发者！
这是我们试图在生态系统层面上解决的一个巨大的问题。 
它不是孤立的任何特定的CMS，你会发现这些不安全的插件等都是类似的。</p>

<p>如果使用了类似的CMS，请在插件中搜索<code class="highlighter-rouge">CURLOPT_SSL_VERIFYPEER</code>和<code class="highlighter-rouge">CURLOPT_SSL_VERIFYHOST</code>，你可能会发现有几个将这些值设置为<code class="highlighter-rouge">FALSE</code>。</p>

<h5 id="避免的事情">避免的事情</h5>

<ul>
  <li><a href="https://paragonie.com/blog/2015/05/if-you-re-typing-word-mcrypt-into-your-code-you-re-doing-it-wrong">不要使用<code class="highlighter-rouge">mcrypt</code></a>。这是一个十多年来没有开发出来的密码学库。如果你遵循我们的PHP版本建议，这应该是一个容易避免的错误，因为<code class="highlighter-rouge">mcrypt</code>不再被PHP 7.2和更新的版本支持。</li>
  <li><a href="https://paragonie.com/blog/2017/01/configuration-driven-php-security-advice-considered-harmful">配置驱动的安全建议</a>应该大部分地忽略。
如果你正在阅读PHP安全性指南，并告诉你更改php.ini设置而不是编写更好的代码，那么你可能正在阅读过时的建议。关闭窗口并转到一些和<code class="highlighter-rouge">register_globals</code>无关的文章上吧。</li>
  <li><a href="https://paragonie.com/blog/2017/03/jwt-json-web-tokens-is-bad-standard-that-everyone-should-avoid">不要使用JOSE（JWT，JWS，JWE）</a>，这是一套互联网标准，它编纂了一系列容易出错的密码设计。尽管由于某种原因，被写入了标准，也吸引了很多传道人。</li>
  <li><a href="https://paragonie.com/blog/2015/09/comprehensive-guide-url-parameter-encryption-in-php">加密URL参数</a>是公司常用来模糊元数据的反模式（例如，我们有多少用户？）。 
它带来了实施错误的高风险，也造成了错误的安全感。
我们在链接的文章中提出了一个更安全的选择。</li>
  <li>除非迫不得已，否则<a href="https://paragonie.com/blog/2016/09/untangling-forget-me-knot-secure-account-recovery-made-simple">不要提供“我忘记了我的密码”的功能</a>。
不要讳言：密码重置功能是一个后门。 
有一些方法可以实施以抵御合理的威胁模型，
但高风险用户应该不被考虑。</li>
  <li><a href="https://paragonie.com/blog/2016/12/everything-you-know-about-public-key-encryption-in-php-is-wrong">避免使用RSA</a>，改用libsodium。如果你必须使用RSA，请确保指定OAEP填充。</li>
</ul>

<div class="language-php highlighter-rouge"><pre class="highlight"><code> <span class="cp">&lt;?php</span>

 <span class="nb">openssl_private_decrypt</span><span class="p">(</span>
    <span class="nv">$ciphertext</span><span class="p">,</span>
    <span class="nv">$decrypted</span><span class="p">,</span> <span class="c1">// Plaintext gets written to this variable upon success,
</span>    <span class="nv">$privateKey</span><span class="p">,</span>
    <span class="nx">OPENSSL_PKCS1_OAEP_PADDING</span> <span class="c1">// Important: DO NOT OMIT THIS!
</span><span class="p">);</span>
</code></pre>
</div>

<p>如果你不得不使用PKCS＃1 v1.5填充，那么无论你与哪个集成在一起，
几乎肯定会受到<a href="https://robotattack.org/">ROBOT</a>的影响，
请以允许明文泄露和签名伪造的漏洞将其报告给相应的供应商（或US-CERT）。</p>

<h4 id="专业用法">专业用法</h4>

<p>现在你已经掌握了在2018年及以后构建安全PHP应用程序的基础知识，接下来我们来看一些更专业的用法。</p>

<h5 id="可搜索的加密">可搜索的加密</h5>

<blockquote>
  <p>深入探究：<a href="https://paragonie.com/blog/2017/05/building-searchable-encrypted-databases-with-php-and-sql">使用PHP和SQL构建可搜索的加密数据库</a></p>
</blockquote>

<p>可搜索的加密数据库是可取的，但被广泛认为是不太可能实现的。
上面链接的博客文章试图通过改进我们解决方案来实现，但本质上是这样的：</p>
<ul>
  <li>设计你的架构，以便数据库（database compromise）不会让攻击者访问你的加密密钥。</li>
  <li>用一个密钥加密数据。</li>
  <li>基于HMAC或具有静态盐的安全KDF（secure KDF with a static salt）创建多个索引（具有自己独特的密钥）</li>
  <li>可选：截断步骤3的输出，将其用作布隆过滤器（Bloom filter）</li>
  <li>在SELECT查询中使用步骤3或4的输出</li>
  <li>解密结果。</li>
</ul>

<p>在这个过程中的任何一步，你都可以根据实际使用情况进行不同的权衡。</p>

<h5 id="没有side-channels的基于令牌的身份验证">没有Side-Channels的基于令牌的身份验证</h5>

<blockquote>
  <p>深入探究： <a href="https://paragonie.com/blog/2017/02/split-tokens-token-based-authentication-protocols-without-side-channels">Split Tokens: Token-Based Authentication Protocols without Side-Channels</a></p>
</blockquote>

<p>说到数据库（上一节），你是否知道SELECT查询理论上可能是定时信息泄漏的来源？</p>

<p>简单的缓解措施：</p>

<ul>
  <li>把你的认证令牌分为两半</li>
  <li>一半在SELECT查询中使用</li>
  <li>后一半在恒定的时间（constant-time）验证
    <ul>
      <li>可以选择将后半部分的散列存储在数据库中。这对于只能使用一次的令牌是有意义的，例如 密码重置或“在此计算机上记住我”的令牌</li>
    </ul>
  </li>
</ul>

<p>即使可以使用定时泄漏来窃取一半的令牌，剩下的也需要暴力破解才能成功。</p>

<h5 id="开发安全的api">开发安全的API</h5>

<blockquote>
  <p>深入探究： <a href="https://paragonie.com/blog/2017/06/hardening-your-php-powered-apis-with-sapient">Hardening Your PHP-Powered APIs with Sapient</a></p>
</blockquote>

<p>我们写了<a href="https://github.com/paragonie/sapient">SAPIENT</a>（the <strong>S</strong>ecure <strong>API</strong> <strong>EN</strong>gineering <strong>T</strong>oolkit），
让服务器到服务器验证的消息传递变得简单易行。
除了HTTPS提供的安全性之外，
<code class="highlighter-rouge">Sapient</code>允许你使用共享密钥或公钥来加密和验证消息。 
这使得即使存在中间攻击者，并设有流氓证书颁发机构，
你也可以使用<code class="highlighter-rouge">Ed25519</code>对API请求和响应进行身份验证，
或者将消息加密到只能由接收方服务器的密钥解密的目标服务器。 
由于每个HTTP消息体都通过安全密码进行身份验证，
所以可以安全地使用它来代替<code class="highlighter-rouge">stateful token juggling protocols</code>（例如 OAuth）。
但是，在密码学方面，在做任何不规范的事情之前，
总要确保他们的实现是由专家研究的。</p>

<p>所有<code class="highlighter-rouge">Sapient</code>使用的密码算法都由<code class="highlighter-rouge">Sodium cryptography library</code>提供。</p>

<p>进一步阅读：</p>

<ul>
  <li><a href="https://github.com/paragonie/sapient/tree/master/docs">Sapient Documentation</a></li>
  <li><a href="https://github.com/paragonie/sapient/blob/master/docs/Tutorial.md">Sapient Tutorial</a></li>
  <li><a href="https://github.com/paragonie/sapient/blob/master/docs/Specification.md">Sapient Specification</a></li>
</ul>

<p><code class="highlighter-rouge">Paragon Initiative Enterprises</code>已经在其许多产品（包括许多开源软件项目）中使用了<code class="highlighter-rouge">Sapient</code>，
并将继续添加软件项目到<code class="highlighter-rouge">Sapient</code>用户群中。</p>

<h5 id="使用chronicle记录安全事件">使用Chronicle记录安全事件</h5>

<blockquote>
  <p>深入探究： <a href="https://paragonie.com/blog/2017/07/chronicle-will-make-you-question-need-for-blockchain-technology">Chronicle Will Make You Question the Need for Blockchain Technology</a></p>
</blockquote>

<p><a href="https://github.com/paragonie/chronicle">Chronicle</a>是一个基于散列链数据结构的仅追加密码分类账（append-only cryptographic ledger），
具有很多吸引公司“区块链”技术的属性，而不会过分矫枉过正。</p>

<p>除了仅追加密码分类账（append-only cryptographic ledger）这个具有创造性的用例之外，
<code class="highlighter-rouge">Chronicle</code>集成到SIEM中时，也可以十分有亮点，
因为你可以将安全关键事件发送到私人<code class="highlighter-rouge">Chronicle</code>中，并且它们是不能被改变的。</p>

<p>如果你的<code class="highlighter-rouge">Chronicle</code>设置为将其摘要散列交叉签名到其他<code class="highlighter-rouge">Chronicle</code>实例，
或者如果有其他实例配置为复制你的<code class="highlighter-rouge">Chronicle</code>内容，攻击者就很难篡改你的安全事件日志。</p>

<p>在<code class="highlighter-rouge">Chronicle</code>的帮助下，你可以获得区块链所承诺的弹性特性（resilience），而没有任何隐私，性能或可伸缩性问题。</p>

<p>要将数据发布到本地<code class="highlighter-rouge">Chronicle</code>，你可以使用任何与<a href="https://paragonie.com/blog/2017/12/2018-guide-building-secure-php-software#secure-api-sapient">Sapient-compatible API</a>，
但最简单的解决方案称为<a href="https://github.com/paragonie/quill">Quill</a>。</p>

<h4 id="作者的一些话">作者的一些话</h4>

<p>一些聪明的读者可能注意到我们引用了很多我们自己的工作（博客文章和开源软件），当然也不仅仅引用了我们自己的工作。</p>

<p>这绝不是偶然的。</p>

<p>自从我们在2015年初成立以来，一直在编写安全库并参与提高PHP生态系统安全性的工作。
我们已经涉足了很多领域，而且我们的安全工程师（他们最近推动了更安全的加密技术加入PHP核心，就在最近的PHP 7.2中）
自我担保地说，并不擅长自我炒作，或是对已经做过的工作持续热情。
你很可能没有听说我们多年来开发的工具或库。对于这个，深感抱歉。</p>

<p>但是，我们也不可能成为各方面的先行者，所以我们尽可能地选择，重视公共利益而不是贪图小利的行业专家工作。
这也是为什么浏览器安全的许多章节都参考了<a href="https://scotthelme.co.uk/">Scott Helme</a>和公司的工作，
他们在为开发人员提供这些新的安全功能方面具有可访问性和可理解性。</p>

<p>本指南当然不会是详尽的。
编写不安全代码的方法几乎和编写代码的方法一样多。
<strong>安全是一种心态，而不是目的地。</strong>
随着上面所写的一切，以及后面涉及的资源，我们希望这将有助于全世界的开发人员，
从今天开始用PHP编写安全的软件。</p>

<h4 id="资源">资源</h4>

<p>如果你已经按照本页上的所有内容进行了操作，
并且需要更多内容，则可能会对我们策划的阅读列表感兴趣，以便学习应用程序安全性。</p>

<p>如果你认为自己编写的代码足够安全，并希望我们从安全工程师的角度对其进行评判，
这也是我们为客户提供的服务。</p>

<p>你如果为一家要进行合规性测试（PCI-DSS，ISO 27001等）的公司工作，可能还想聘请我们公司来审核你的源代码。
我们的流程比其他安全咨询公司更适合开发者。</p>

<p>接下来是PHP和信息安全社区提供的资源列表，这些资源帮助互联网更加安全。</p>

<ul>
  <li>
    <p><a href="http://www.phptherightway.com/">PHP: The Right Way</a>：现代PHP开发的实用指南，免费在线。</p>
  </li>
  <li>
    <p><a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">Mozilla’s SSL Config Generator</a></p>
  </li>
  <li>
    <p><a href="https://letsencrypt.org/">Let’s Encrypt</a>：证书颁发机构，通过提供免费TLS证书，为创建更安全的Internet做了很多。</p>
  </li>
  <li>
    <p><a href="https://www.ssllabs.com/ssltest">Qualys SSL Labs</a>：为TLS配置提供了一个快速而简单的测试套件。
几乎每个人都使用这个来解决他们的密码组和证书问题，理由很充分：<strong>It does its job well.</strong></p>
  </li>
  <li>
    <p><a href="https://securityheaders.io/">Security Headers</a>：可以检验你的网站在使用浏览器安全功能来保护用户方面的表现如何。</p>
  </li>
  <li>
    <p><a href="https://report-uri.com/">Report-URI</a>：一个很好的免费资源，提供监控 CSP/HPKP 等安全策略的实时安全报告服务。
他们给你一个Report-URI，你可以传递给你的用户的浏览器，
如果有什么事情发生或有人发现XSS攻击媒介，他们会投诉Report-URI。 Report-URI会汇总这些错误，
并允许你更好地对这些报告进行疑难解答和分类。</p>
  </li>
  <li>
    <p><a href="https://www.ripstech.com/php-security-calendar-2017">PHP Security Advent Calenda</a>：<a href="https://www.ripstech.com/">RIPSTech</a>旗下的团队负责。</p>
  </li>
  <li>
    <p><a href="https://snuffleupagus.readthedocs.io/">Snuffleupagus</a>：一个面向安全的PHP模块（<a href="https://github.com/sektioneins/suhosin">Suhosin</a>的精神继承者，似乎在很大程度上会被放弃）</p>
  </li>
  <li>
    <p><a href="https://phpdelusions.net/">PHP Delusions</a>：一个致力于更好地使用PHP的网站。
大部分的口吻是非常有见地的，
作者对技术的准确性和清晰度的奉献使得值得一读，特别是对于那些不太喜欢PDO功能的人来说。</p>
  </li>
  <li>
    <p><a href="https://haveibeenpwned.com/">Have I Been Pwned?</a>：帮助用户发现他们的数据是否属于过时数据泄露。</p>
  </li>
</ul>

<h4 id="结尾">结尾</h4>

<p>原文地址：<a href="https://paragonie.com/blog/2017/12/2018-guide-building-secure-php-software">The 2018 Guide to Building Secure PHP Software - P.I.E. Staff</a></p>

<p>为避免歧义，部分专业名词和语句保留了原文。翻译过程借助了Google和Google翻译，本人英文水平有限，如有错误感谢指出修正。</p>

<p>PHP可以说是一门受争论的语言，有时候也羞愧于自己都大四了还纠结于该问题，迷茫不定。看了作者的努力，特别从<strong>作者的一些话</strong>中感受到，
原来有很多人在为改善PHP生态努力，有点感动，多了些坚定。</p>

<p>共勉吧！</p>


                <hr>

                <div id="gitment"></div>


                


                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2017/12/08/elasticsearch-learn-notes-1/" data-toggle="tooltip" data-placement="top" title="you know, for search - ElasticSearch 学习笔记(1)">&larr; Previous Post</a>
                    </li>
                    
                    
                </ul>


                

                

            </div>

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
                				<a href="/tags/#博客" title="博客" rel="1">
                                    博客
                                </a>
                            
        				
                            
                				<a href="/tags/#CentOS" title="CentOS" rel="1">
                                    CentOS
                                </a>
                            
        				
                            
                				<a href="/tags/#LNMP" title="LNMP" rel="2">
                                    LNMP
                                </a>
                            
        				
                            
                				<a href="/tags/#Nginx" title="Nginx" rel="1">
                                    Nginx
                                </a>
                            
        				
                            
                				<a href="/tags/#PHP" title="PHP" rel="3">
                                    PHP
                                </a>
                            
        				
                            
                				<a href="/tags/#crontab" title="crontab" rel="1">
                                    crontab
                                </a>
                            
        				
                            
                				<a href="/tags/#MySQL" title="MySQL" rel="1">
                                    MySQL
                                </a>
                            
        				
                            
                				<a href="/tags/#SAE" title="SAE" rel="1">
                                    SAE
                                </a>
                            
        				
                            
                				<a href="/tags/#Swift" title="Swift" rel="1">
                                    Swift
                                </a>
                            
        				
                            
                				<a href="/tags/#LAMP" title="LAMP" rel="1">
                                    LAMP
                                </a>
                            
        				
                            
                				<a href="/tags/#LANMP" title="LANMP" rel="1">
                                    LANMP
                                </a>
                            
        				
                            
                				<a href="/tags/#LNSMP" title="LNSMP" rel="1">
                                    LNSMP
                                </a>
                            
        				
                            
                				<a href="/tags/#axios" title="axios" rel="1">
                                    axios
                                </a>
                            
        				
                            
                				<a href="/tags/#JavaScript" title="JavaScript" rel="1">
                                    JavaScript
                                </a>
                            
        				
                            
                				<a href="/tags/#ElasticSearch" title="ElasticSearch" rel="1">
                                    ElasticSearch
                                </a>
                            
        				
                            
                				<a href="/tags/#翻译" title="翻译" rel="1">
                                    翻译
                                </a>
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">
                    
                        <li><a href="http://idoubi.cc/">艾逗笔</a></li>
                    
                        <li><a href="http://blog.csdn.net/will4906">will4906</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>


<!-- gitment start-->
<script src="/js/gitment.browser.min.js"></script>
<script type="text/javascript">

  var owner = 'littlesqx'
  var repo = 'Littlesqx.github.io'
  var client_id = 'd4026099a50841ea3513'
  var client_secret = '56b15436e7ce879ba65036524d27bf21f24e02c4'

  var gitment = new Gitment({
      id: window.location.pathname,
      owner: owner,
      repo: repo,
      oauth: {
        client_id: client_id,
        client_secret: client_secret,
      },
  })
  gitment.render('gitment')
</script>
<!-- gitment end-->









<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:https://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    


                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/littlesqx">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a target="_blank" href="https://www.upyun.com">
                            <img src="https://littlesqx-github-io.b0.upaiyun.com/img/upyun_logo.png" style="width: 140px; cursor: pointer;">
                        </a>
                    </li>
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Littlesqx Blog 2017
                    <br>
                    Theme by <a href="https://huangxuan.me">Hux</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="https://littlesqx-github-io.b0.upaiyun.com/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="https://littlesqx-github-io.b0.upaiyun.com/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="https://littlesqx-github-io.b0.upaiyun.com/js/hux-blog.min.js "></script>

<!-- nprogress JavaScript -->
<script src="https://littlesqx-github-io.b0.upaiyun.com/js/nprogress.min.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
-->
<!--
    <script>
        async("https://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="https://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://littlesqx-github-io.b0.upaiyun.com/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://littlesqx-github-io.b0.upaiyun.com/js/fastclick.min.js ", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-111356273-1';
    var _gaDomain = 'littlesqx.github.io';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->


<!-- nprogress -->
<script>
  $(function(){
    NProgress.configure({ showSpinner: false, speed: 300 });
    NProgress.start();
  })
  $( window ).load(function() {
    NProgress.done();
  });
</script>



<!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0" /> -->
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
